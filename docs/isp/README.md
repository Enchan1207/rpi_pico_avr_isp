# AVR Serial programming によるプログラムの書き込み

## 概要

AVRマイコンには _Serial programming_ (以降ISP)と呼ばれる方法を用いて書込むことができます。
これは、マイコンが持つフラッシュメモリやEEPROMのデータをSPI経由で読み書きするものです。

ISPは4byteのコマンドと1byteのレスポンスをターゲットMCUと書込み器とでやりとりすることによって行われます。
特に支持のない限りレスポンスはコマンドの4byteめを送出した際の戻り値として得られます (一部例外あり)。

## 書込みシーケンス

基本的な書込みシーケンスを以下に示します。

1. `RESET`, `SCK` をLOWにする。
2. 20ms以上待機したのち、コマンド _Programming Enable_ を送信し、同期を確認する。
3. フラッシュメモリにデータを書き込む。
4. (必要ならば) EEPROMにデータを書き込む。
5. (必要ならば) フラッシュメモリ・EEPROMを読み出し、データが正しく書き込まれたか確認する。
6. `RESET` をHIGHにしてISPを終了する。

### ページ書込み

フラッシュメモリは **ページ** と呼ばれる単位で分割され、各ページはさらに **ワード** という単位で区切られています。

データの読み込みはワード単位あるいはバイト単位で行うことができますが、
書き込む際はページごと一旦消去し、書き込む必要があります。(少しずつ書き換えるということができません)

このため、ISPにおいては **ページバッファ**と呼ばれる一時領域にデータを蓄積し、
最後にコマンド _Write Program Memory Page_ を送信してページ全体を書き換えるという方法をとっています。

たとえばATtiny2313の場合、フラッシュメモリの構造はデータシートTable 68から

- フラッシュメモリサイズ: 1024ワード
- ページサイズ: 16ワード (4bit)
- ページ数: 64 (1024 / 16) (6bit)

とあります。
よってアドレス空間は10bit、うち下位4bitは各ページ内のアドレスとなります。

```text
|--- page ---|- word -|
| 9 8 7 6 5 4| 3 2 1 0|
```

ATmega328Pの場合、Table 27-9 から

- フラッシュメモリサイズ: 16384ワード
- ページサイズ: 64ワード (6bit)
- ページ数: 256 (16384 / 64) (8bit)

となるため、アドレス空間は14bit、うち下位6bitは各ページ内のアドレスとなります。

```text
|----- page -----|--- word ---|
| D C B A 9 8 7 6| 5 4 3 2 1 0|
```

## コマンドリファレンス

以下、ISPにおいてやり取りされるコマンドの詳細を整理します。

### Programming Enable

接続されているマイコンのISPを有効化します。成功した場合は第3バイト送出時に `$53` が返ります。
このコマンドのみ、第4バイト送出時ではなく第3バイト送出時にレスポンスが返ります。

- コマンド: `$AC $53 $00 $00`
- レスポンス:
  - ISPの有効化に成功した場合: `xx $AC $53 xx`
  - ISPの有効化に失敗した場合: `xx $AC xx xx`

### Chip Erase

マイコンのフラッシュメモリとEEPROMの情報を消去します。

- コマンド: `$AC $80 $00 $00`
- レスポンス: なし

### Read Program Memory (Low)

フラッシュメモリの指定されたアドレスに格納されているデータの下位バイトを読み込みます。

- コマンド: `$20 am al xx`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
- レスポンス: 読み出したデータ

### Read Program Memory (High)

フラッシュメモリの指定されたアドレスに格納されているデータの上位バイトを読み込みます。

- コマンド: `$28 am al xx`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
- レスポンス: 読み出したデータ

### Load Program Memory Page (Low)

指定されたページアドレスの下位バイトにデータを書き込みます。

- コマンド: `$40 $00 aa vv`
  - `aa`: ページアドレス
  - `vv`: 書き込むデータ
- レスポンス: なし

### Load Program Memory Page (High)

指定されたページアドレスの上位バイトにデータを書き込みます。

- コマンド: `$48 $00 aa vv`
  - `aa`: ページアドレス
  - `vv`: 書き込むデータ
- レスポンス: なし

### Write Program Memory Page

指定されたアドレスのフラッシュメモリページにデータを書き込みます。

- コマンド: `$4C am al $00`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
- レスポンス: なし

### Read EEPROM Memory

EEPROMの指定されたアドレスに格納されているデータを読み込みます。

- コマンド: `$A0 am al xx`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
- レスポンス: 読み出したデータ

### Write EEPROM Memory

EEPROMの指定されたアドレスにデータを書き込みます。

- コマンド: `$C0 am al vv`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
  - `vv`: 書き込むデータ
- レスポンス: なし

### Load EEPROM Memory Page

指定されたアドレスのEEPROMページにデータを書き込みます。

- コマンド: `$C1 $00 aa vv`
  - `aa`: ページアドレス
  - `vv`: 書き込むデータ
- レスポンス: なし

### Write EEPROM Memory Page

指定されたアドレスのEEPROMページにデータを書き込みます。

- コマンド: `$C2 am al $00`
  - `am`: アドレスのMSB
  - `al`: アドレスのLSB
- レスポンス: なし

### Read Lock Bits

施錠ビットの値を取得します。

- コマンド: `$58 $00 $00 xx`
- レスポンス: 施錠ビットの値

### Write Lock Bits

施錠ビットに値を書き込みます。

- コマンド: `$58 $00 $00 aa`
  - `aa`: 施錠ビットの値
- レスポンス: なし

### Read Signature Byte

デバイスのシグネチャバイトを読み込みます。

- コマンド: `$30 $00 aa xx`
  - `aa`: シグネチャバイトのアドレス(`0x00` ~ `0x02`)
- レスポンス: シグネチャバイトの値

### Write Fuse Bits

デバイスの下位ヒューズビットに値を書き込みます。

- コマンド: `$AC $A0 $00 aa`
  - `aa`: ヒューズビットの値
- レスポンス: なし

### Write Fuse High Bits

デバイスの上位ヒューズビットに値を書き込みます。

- コマンド: `$AC $A8 $00 aa`
  - `aa`: ヒューズビットの値
- レスポンス: なし

### Write Extended Fuse Bits

デバイスの拡張ヒューズビットに値を書き込みます。

- コマンド: `$AC $A4 $00 aa`
  - `aa`: ヒューズビットの値
- レスポンス: なし

### Read Fuse Bits

デバイスの下位ヒューズビットを読み込みます。

- コマンド: `$50 $00 $00 xx`
- レスポンス: ヒューズビットの値

### Read Fuse High Bits

デバイスの上位ヒューズビットを読み込みます。

- コマンド: `$58 $08 $00 xx`
- レスポンス: ヒューズビットの値

### Read Extended Fuse Bits

デバイスの拡張ヒューズビットを読み込みます。

- コマンド: `$50 $08 $00 xx`
- レスポンス: ヒューズビットの値

### Read Calibration Byte

デバイスの発振器キャリブレーションバイトを読み込みます。

- コマンド: `$38 $00 $00 xx`
- レスポンス: キャリブレーションバイトの値

### Poll RDY/BSY

デバイスのビジー状態を確認します。

- コマンド: `$F0 $00 $00 xx`
- レスポンス: `0x01` なら動作中、`0x00` なら完了
